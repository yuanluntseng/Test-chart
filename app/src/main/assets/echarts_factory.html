<!DOCTYPE html><html lang="zh-TW"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><title>ECharts Factory</title><script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script><style>*,::after,::before{box-sizing:border-box;margin:0;padding:0}body,html{width:100%;height:100%;background:#0f1117;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;overflow-x:hidden}#chart-grid{display:flex;flex-direction:column;gap:16px;padding:16px;width:100%;min-height:100%}.chart-card{background:linear-gradient(135deg,#1a1d2e 0,#16213e 100%);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px;box-shadow:0 4px 24px rgba(0,0,0,.4);animation:slideInUp .4s cubic-bezier(.16,1,.3,1) both}.chart-title{color:#e2e8f0;font-size:14px;font-weight:600;letter-spacing:.5px;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid rgba(255,255,255,.07)}.chart-container{width:100%;height:260px}.chart-skeleton{width:100%;height:260px;background:linear-gradient(90deg,rgba(255,255,255,.04) 25%,rgba(255,255,255,.08) 50%,rgba(255,255,255,.04) 75%);background-size:200% 100%;animation:shimmer 1.5s infinite;border-radius:8px}.chart-error{width:100%;height:80px;display:flex;align-items:center;justify-content:center;color:#fc8181;font-size:13px;background:rgba(252,129,129,.06);border-radius:8px;border:1px dashed rgba(252,129,129,.3)}@keyframes slideInUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}</style></head><body><div id="chart-grid"></div><script>const chartRegistry={};let globalTheme={backgroundColor:"transparent",textColor:"#cbd5e1",axisLineColor:"rgba(255,255,255,0.15)",splitLineColor:"rgba(255,255,255,0.06)",palette:["#6366f1","#22d3ee","#f59e0b","#10b981","#f43f5e","#a78bfa","#34d399","#fb923c","#60a5fa","#e879f9"]};function deepMerge(e,t){if(!t)return e;const r=Object.assign({},e);return Object.keys(t).forEach(o=>{r[o]=t[o]&&"object"==typeof t[o]&&!Array.isArray(t[o])?deepMerge(e[o]||{},t[o]):t[o]}),r}const PresetRegistry={_store:{},register(e,t){return t.buildOption?(this._store[e]=t,console.log(`[PresetRegistry] Registered: "${e}"`),this):(console.warn(`[PresetRegistry] "${e}" 缺少 buildOption 方法，已忽略`),this)},has(e){return e in this._store},get(e){return this._store[e]},list(){return Object.keys(this._store)}};let _helpers;function pivotData(e,t,r,o){const n=[],a=new Set;e.forEach(e=>{const t=String(e[r]);a.has(t)||(n.push(t),a.add(t))});const s=[],i=new Set;e.forEach(e=>{const r=String(e[t]);i.has(r)||(s.push(r),i.add(r))});const c={};e.forEach(e=>{const n=String(e[r]),a=String(e[t]);c[n]||(c[n]={}),c[n][a]=void 0!==e[o]&&null!==e[o]?Number(e[o]):0});const l=n.map(e=>{const t=[e];return s.forEach(r=>t.push(c[e]&&c[e][r]||0)),t});return{dimensions:[r,...s],source:l,categories:s}}function _makeXAxis(e){return{type:"category",axisLine:{lineStyle:{color:e.axisLineColor}},axisTick:{show:!1},axisLabel:{color:e.textColor,fontSize:11}}}function _makeYAxis(e){return{splitLine:{lineStyle:{color:e.splitLineColor,type:"dashed"}},axisLabel:{color:e.textColor,fontSize:11}}}function _makeTooltip(e){return{trigger:"pie"===e?"item":"axis",backgroundColor:"rgba(15,17,23,0.92)",borderColor:"rgba(255,255,255,0.1)",textStyle:{color:"#f1f5f9",fontSize:12}}}function _makeLegend(e){return{top:"bottom",textStyle:{color:e.textColor,fontSize:11},icon:"roundRect",itemWidth:12,itemHeight:6}}function _makeGrid(e){return Object.assign({left:"3%",right:"4%",bottom:"14%",top:"6%",containLabel:!0},e||{})}function ensureChartCard(e,t){const r=document.getElementById("chart-grid");let o=document.getElementById("mount_"+e);if(o)return o;const n=document.createElement("div");if(n.id="card_"+e,n.className="chart-card",t){const e=document.createElement("div");e.className="chart-title",e.textContent=t,n.appendChild(e)}const a=document.createElement("div");return a.id="skeleton_"+e,a.className="chart-skeleton",n.appendChild(a),o=document.createElement("div"),o.id="mount_"+e,o.className="chart-container",o.style.display="none",n.appendChild(o),r.appendChild(n),o}function activateMount(e){const t=document.getElementById("skeleton_"+e),r=document.getElementById("mount_"+e);t&&(t.style.display="none"),r&&(r.style.display="block")}function showError(e,t){const r=document.getElementById("card_"+e);if(!r)return;const o=document.getElementById("skeleton_"+e);o&&(o.style.display="none");const n=document.createElement("div");n.className="chart-error",n.textContent="⚠ "+(t||"圖表載入失敗"),r.appendChild(n)}function buildOption(e,t,r,o,n,a){const s=globalTheme;if(PresetRegistry.has(e)){const i=PresetRegistry.get(e),c=i.transformData?i.transformData(t,{encode:o,dimensions:r,stackField:a}):t;return i.buildOption(c,{encode:o,dimensions:r,stackField:a,options:n},_helpers,s)}const i={line:{smooth:!0,symbol:"circle",symbolSize:6,lineStyle:{width:2},areaStyle:{opacity:.12}},bar:{barMaxWidth:40,itemStyle:{borderRadius:[4,4,0,0]}},pie:{radius:["40%","70%"],center:["50%","48%"],label:{color:s.textColor,fontSize:11}},scatter:{symbolSize:8},radar:{},funnel:{},gauge:{},candlestick:{}},c=_makeXAxis(s),l=_makeYAxis(s),d=_makeTooltip(e),u=_makeLegend(s);if(a&&o&&o.x&&o.y){const r=pivotData(t,a,o.x,o.y),m={dimensions:r.dimensions,source:r.source},g=r.categories.map(t=>{const r={type:e,name:t,stack:"total",encode:{x:o.x,y:t},emphasis:{focus:"series"}},n=Object.assign({},i[e]||{});return"bar"===e&&delete n.itemStyle,Object.assign(r,n)});"bar"===e&&g.length>0&&(g[g.length-1].itemStyle={borderRadius:[4,4,0,0]});let p={backgroundColor:s.backgroundColor,color:s.palette,dataset:m,tooltip:d,legend:u,series:g,xAxis:c,yAxis:l,grid:_makeGrid()};return n&&(p=deepMerge(p,n)),p}const m={source:t};r&&r.length>0&&(m.dimensions=r);const g=[deepMerge({type:e,encode:o||{},emphasis:{focus:"series"}},i[e]||{})];let p={backgroundColor:s.backgroundColor,color:s.palette,dataset:m,tooltip:d,legend:u,series:g};return["pie","radar","funnel","gauge"].includes(e)||(p.xAxis=c,p.yAxis=l,p.grid=_makeGrid({bottom:"12%"})),n&&(p=deepMerge(p,n)),p}_helpers={deepMerge:deepMerge,pivotData:pivotData,makeXAxis:_makeXAxis,makeYAxis:_makeYAxis,makeTooltip:_makeTooltip,makeLegend:_makeLegend,makeGrid:_makeGrid},PresetRegistry.register("bar-normalized",{transformData(e,{stackField:t,encode:r}){if(!t||!r)return e;const o=r.x,n=r.y,a={};return e.forEach(e=>{const t=String(e[o]);a[t]=(a[t]||0)+Number(e[n]||0)}),e.map(e=>{const t=String(e[o]),r=a[t]?Math.round(1e3*Number(e[n]||0)/a[t])/10:0;return Object.assign({},e,{[n]:r})})},buildOption(e,{encode:t,stackField:r,options:o},n,a){const{pivotData:s,makeXAxis:i,makeYAxis:c,makeTooltip:l,makeLegend:d,makeGrid:u,deepMerge:m}=n,g=a,p=s(e,r,t.x,t.y),h=Object.assign(l("bar"),{formatter(e){let t=`<b>${e[0].axisValue}</b><br/>`;return e.forEach(e=>{const r=Array.isArray(e.value)?e.value[e.encode.y[0]]:e.value;t+=`${e.marker}${e.seriesName}: <b>${r}%</b><br/>`}),t}}),y=p.categories.map((e,r)=>({type:"bar",name:e,stack:"total",encode:{x:t.x,y:e},barMaxWidth:40,label:{show:!0,formatter:e=>{const t=Array.isArray(e.value)?e.value[e.encode.y[0]]:e.value;return t>5?t+"%":""}},itemStyle:r===p.categories.length-1?{borderRadius:[4,4,0,0]}:{},emphasis:{focus:"series"}}));let b={backgroundColor:g.backgroundColor,color:g.palette,dataset:{dimensions:p.dimensions,source:p.source},tooltip:h,legend:d(g),series:y,xAxis:i(g),yAxis:Object.assign(c(g),{max:100,axisLabel:{color:g.textColor,fontSize:11,formatter:"{value}%"}}),grid:u()};return o&&(b=m(b,o)),b}}),PresetRegistry.register("gauge-ring",{buildOption(e,{encode:t,options:r},o,n){const{deepMerge:a,makeLegend:s}=o,i=n,c=t.itemName||"name",l=t.value||"value";e[0];let d={backgroundColor:i.backgroundColor,color:i.palette,series:[{type:"gauge",startAngle:90,endAngle:-270,pointer:{show:!1},progress:{show:!0,overlap:!1,roundCap:!0,clip:!1},axisLine:{lineStyle:{width:18}},splitLine:{show:!1},axisTick:{show:!1},axisLabel:{show:!1},data:e.map((e,t)=>({name:e[c],value:e[l],title:{offsetCenter:["0%",40*t-40+"%"],color:i.textColor,fontSize:12},detail:{offsetCenter:["0%",40*t-15+"%"],color:i.palette[t]||"#fff",fontSize:16,formatter:"{value}%"}}))}]};return r&&(d=a(d,r)),d}}),window.renderChart=function(e,t,r){try{const o=JSON.parse(t),n=JSON.parse(r),a=n.type||"bar",s=n.encode||{},i=n.dimensions||[],c=n.title||"",l=n.options||null,d=n.stackField||null,u=ensureChartCard(e,c);let m=chartRegistry[e];if(!m){activateMount(e),m=echarts.init(u,null,{renderer:"canvas"}),chartRegistry[e]=m;new ResizeObserver(()=>m.resize()).observe(u)}const g=buildOption(a,o,i,s,l,d);m.setOption(g,{notMerge:!0,lazyUpdate:!1})}catch(t){console.error("[EChartsFactory] renderChart error:",t),showError(e,t.message)}},window.removeChart=function(e){const t=chartRegistry[e];t&&(t.dispose(),delete chartRegistry[e]);const r=document.getElementById("card_"+e);r&&r.remove()},window.clearAllCharts=function(){Object.keys(chartRegistry).forEach(e=>{chartRegistry[e].dispose(),delete chartRegistry[e]}),document.getElementById("chart-grid").innerHTML=""},window.setGlobalTheme=function(e){try{const t=JSON.parse(e);globalTheme=deepMerge(globalTheme,t)}catch(e){console.warn("[EChartsFactory] setGlobalTheme parse error:",e)}},window.registerChartPreset=function(typeName,presetJson){try{const preset=eval("("+presetJson+")");PresetRegistry.register(typeName,preset)}catch(e){console.error("[PresetRegistry] registerChartPreset failed:",e)}},window.onEChartsReady=function(){window.Android&&"function"==typeof window.Android.onPageReady&&window.Android.onPageReady("echarts_factory")},document.addEventListener("DOMContentLoaded",function(){"undefined"!=typeof echarts&&window.onEChartsReady()})</script></body></html>